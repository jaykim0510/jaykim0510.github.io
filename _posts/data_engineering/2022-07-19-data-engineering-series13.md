---
layout: post
title:  'Data Engineering Series [Part12]: Database Internals 개요'
description: 
date:   2022-07-19 15:01:35 +0300
image:  '/images/data_engineering_logo.png'
logo_image:  '/images/data_engineering_logo.png'
categories: DE
tags: Data_Engineering
---
---

**Table of Contents**
{: #toc }
*  TOC
{:toc}

---

데이터베이스에서 중요한 개념: B-트리 알고리즘, 캐시 정책, 상태 복구, 동시성 제어  
(실용적인 측면에서는, 데이터베이스별 기능, 얼마나 빠른지, 어떤 유형의 어플리케이션에 이용되는지, SQL, 쿼리 플랜)  

분산 데이터베이스에서 중요한 개념: 장애 감지, 리더 선출, 분산 트랜잭션, 합의 알고리즘  

# 스토리지 엔진  

데이터베이스 관리 시스템의 주 목적은 데이터를 안정적으로 저장하고 사용자에게 제공하는 것이다. 일반적으로 데이터베이스는 기본 데이터 스토어로 사용되며 애플리케이션의 여러 구성 요소가 공유한다.  

데이터베이스는 모듈식 시스템이다. 요청을 전달하는 전송 계층, 가장 효율적인 쿼리 실행 계획을 결정하는 쿼리 프로세서, 실제 작업을 수행하는 실행 엔진 그리고 스토리지 엔진으로 구성된다.  

스토리지 엔진은 DBMS에서 데이터를 메모리와 디스크에 저장하고 검색 및 관리하는 소프트웨어 컴포넌트로써 각 노드에 데이터를 영구 저장한다. 데이터베이스가 복잡한 쿼리를 수행할 수 있도록 스토리지 엔진은 데이터를 세밀하게 조작할 수 있는 간단한 API를 제공한다. 사용자는 이를 사용해 레코드를 CRUD할 수 있다. 따라서 데이터베이스는 **스토리지 엔진 위에서 스키마와 쿼리 언어, 인덱싱, 트랜잭션 등의 유용한 기능을 제공하는 애플리케이션**이라고 볼 수 있다.  

스토리지 엔진은 DBMS와 독립적으로 개발됐다. 데이터베이스 개발자는 플러그형 스토리지 엔진을 사용해 데이터베이스 시스템을 구현할 수 있다. 예를 들어 DBMS 중 MySQL은 InnoDB, MyISAM, RocksDB라는 스토리지 엔진을 가질 수 있고, 몽고DB는 WiredTiger, In-Memory 스토리지 엔진이 있다.  

## 소개 및 개요

데이터베이스 관리 시스템의 용도는 다양하다. 일시적인 핫 데이터를 주로 저장하는 데 쓰이기도 하고, 장기 보관용 콜드 데이터 스토리지로 쓰이기도 한다. 복잡한 쿼리 분석을 지원하는 시스템도 있는가 하면, 키로만 값을 액세스할 수 있는 스토어도 있다.  

저장 매체에 따라 인메모리 DBMS와 디스크 기반 DBMS로 구분할 수도 있다. 레이아웃에 따라 로우형, 컬럼형, 와이드 컬럼형 DBMS로 구분할 수도 있다.  

또 사용 용도에 따라 온라인 트랜잭션 처리(OLTP), 온라인 분석 처리(OLAP) 데이터베이스로 구분할 수도 있다.  

저장 형태에 따라 로우형 레코드, 키-값 쌍, 다큐멘트형 데이터베이스가 있다.  

### DBMS 구조  

![](/images/db_internals_1.png)  

클라이언트의 요청은 트랜스포트 서브시스템을 통해 전달된다. 요청은 쿼리 형태이고 주로 특정 쿼리 언어로 표현된다. 트랜스포트 서브시스템은 쿼리를 쿼리 프로세서에 전달한다. 쿼리 프로세서는 쿼리를 해석, 분석 및 검증한다. 분석된 쿼리는 쿼리 옵티마이저에 전달된다.  

쿼리는 일반적으로 실행 계획 형태로 표현한다. 실행 계획은 쿼리가 요구하는 결과를 도출하는 데 수행해야 하는 일련의 작업이다.  

스토리지 엔진은 다음과 같은 역할을 담당하는 컴포넌트로 구성된다.  

- 트랜잭션 매니저: 트랜잭션을 스케줄링하고 데이터베이스 상태의 논리적 일관성을 보장한다
- 잠금 매니저: 트랜잭셔넹서 접근하는 데이터베이스 객체에 대한 잠금을 제어한다. 동시 수행 작업이 데이터 무결성을 침해하지 않도록 제어한다.  
- 버퍼 매니저: 데이터 페이지를 메모리에 캐시한다
- 복구 매니저: 로그를 유지 관리하고 장애 발생 시 시스템을 복구한다

스토리지 엔진은 버퍼링, 가변성, 순서화와 같은 요소에 따라 구분된다.  

- 버퍼링
  - 데이터를 디스크에 쓰기 전에 일부를 메모리에 저장할지 여부
  - 물론 모든 디스크 기반도 어느 정도 버퍼를 사용한다
    (디스크의 가장 작은 전송 단위가 블록이므로 블록을 채워서 쓰기 위해 버퍼링 사용)
- 가변성
  - 데이터를 갱신할 때 in-place vs (append-only, copy-on-write)
- 순서화
  - 디스크 페이지에 레코드를 키 순서로 저장할지에 대한 여부
  - 순서화 -> 빠른 읽기, 비순서화 -> 빠른 쓰기

### 인메모리 DBMS, 디스크 기반 DBMS

- 인메모리
  - 메모리에 데이터 저장
  - 디스크는 복구와 로그 저장 용도
  - 단점: RAM의 휘발성(디스크로 보완, 배터리 장착된 RAM 사용), 가격
- 디스크 기반
  - 디스크에 데이터 저장
  - 메모리는 캐시 또는 임시 저장 용도
  - 단점: 랜덤 디스크 접근 속도 << 랜덤 메모리 접근 속도
  - 디스크 기반은 아무리 큰 페이지를 캐시해도 직렬화와 데이터 레이아웃을 유지하는 오버헤드 때문에 인메모리 보다 느리다

인메모리 데이터베이스의 지속성  

인메모리 DBMS는 데이터의 지속성을 보장하고 데잍어 손실을 방지하기 위해 데이터를 디스크에 백업한다. 모든 작업은 로그 파일에 작업 내용을 순차적으로 기록해야 완료된다. 시스템 시작과 복구 시 모든 로그를 재수행하지 않기 위해 디스크에 백업본을 유지한다. 그렇게 함으로써 복구시에는 백업본과 로그를 기반으로 데이터를 재구성한다. (백업본만 있으면 이전 로그는 삭제해도 된다)  

![](/images/db_internals_2.png)    

### 로우형 DBMS, 컬럼형 DBMS

대부분의 데이터베이스는 열과 행으로 구성된 테이블에 레코드를 저장한다. 데이터를 디스크에 저장하는 방식에 따라 데이터베이스를 분류할 수 있다. 컬럼 저장 방식은 테이블을 수직 분할하고, 로우 저장 방식은 수평 분할한다.  

MySQL, PostreSQL 등 대부분의 전통적인 관계형 데이터베이스는 로우형 DBMS이다. MonetDB, C-Store는 컬럼형 오픈소스 데이터베이스이다.  

- 로우형 데이터 레이아웃
  - 이 방식은 여러 필드의 값을 고유 식별 키로 구분할 수 있는 레코드 형식에 적합하다
  - 일반적으로 특정 사용자의 필드는 여러 개가 함꼐 요청되는 경우가 많다
  - 로우형 DBMS는 한 개의 로우씩 접근하는 경우 적합하다
  - 한 블록에 모든 컬럼의 값이 들어가게 된다
  - 특정 사용자의 모든 정보를 읽어올 때는 효율적, 모든 사용자의 특정 필드를 읽어올 때는 비효율적이다

- 컬럼형 데이터 레이아웃
  - 컬럼끼리 디스크에 연속해 저장하는 방식이다
  - 컬럼형 DBMS는 데이터의 추세와 평균 등을 계산하는 집계 분석 작업에 적합하다
  - 다시 레코드 형태로 재구성하기 위해 컬럼 사이의 관계를 정의하는 메타데이터가 필요하다 (각 값마다 키값을 중복저장해야 한다)
  - 최근 몇 년 동안 대용량 데이터에 대한 복잡한 분석 쿼리 사용이 늘어나고 있다
  - 결과적으로 파케이(Parquet), ORC와 같은 컬럼 기반 파일 포맷과 쿠두(Kude)와 같은 컬럼형 DBMS가 각광받고 있다  

같은 컬럼의 여러 값을 한 번에 읽으면 캐시 활용도와 처리 효율성이 높아진다. 같은 자료형끼리 저장하게 되면 압축률도 증가한다. 컬럼형과 로우형 DBMS 중 어떤 것을 사용할지 선택하려면 액세스 패턴을 파악해야 한다. 데이터를 레코드 단위로 접근하고 일반 쿼리와 범위 스캔 요청이 많다면 로우형 DBMS, 여러 로우를 스캔하거나 일부 컬럼에 대한 집계 작업이 많다면 컬럼형 DBMS가 더 적합할 수 있다.  

HBase와 같은 와이드 컬럼 스토어는 같은 자료형을 가지는 컬럼을 단위로 로우 형식으로 저장한다. 이 방식은 키 단위 액세스 패턴에 적합하다.  