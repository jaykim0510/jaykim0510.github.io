I"3<hr />

<p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#도커에서-데이터-관리하기" id="markdown-toc-도커에서-데이터-관리하기">도커에서 데이터 관리하기</a></li>
  <li><a href="#volume" id="markdown-toc-volume">Volume</a>    <ul>
      <li><a href="#실습" id="markdown-toc-실습">실습</a>        <ul>
          <li><a href="#볼륨-생성" id="markdown-toc-볼륨-생성">볼륨 생성</a>            <ul>
              <li><a href="#dockerfile-volume-인스트럭션" id="markdown-toc-dockerfile-volume-인스트럭션">Dockerfile VOLUME 인스트럭션</a></li>
              <li><a href="#docker-volume-명령어" id="markdown-toc-docker-volume-명령어">docker volume 명령어</a></li>
              <li><a href="#docker-compose" id="markdown-toc-docker-compose">docker compose</a></li>
            </ul>
          </li>
          <li><a href="#볼륨-삭제" id="markdown-toc-볼륨-삭제">볼륨 삭제</a></li>
          <li><a href="#볼륨-확인" id="markdown-toc-볼륨-확인">볼륨 확인</a></li>
          <li><a href="#볼륨-마운트" id="markdown-toc-볼륨-마운트">볼륨 마운트</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#bind-mount" id="markdown-toc-bind-mount">Bind Mount</a>    <ul>
      <li><a href="#실습-1" id="markdown-toc-실습-1">실습</a></li>
    </ul>
  </li>
  <li><a href="#참고" id="markdown-toc-참고">참고</a></li>
</ul>

<hr />

<h1 id="도커에서-데이터-관리하기">도커에서 데이터 관리하기</h1>

<ul>
  <li>기본적으로 컨테이너 안에서 생성된 모든 파일은 <strong>컨테이너 레이어에 저장</strong>된다</li>
  <li>그래서, 해당 컨테이너가 삭제되면 데이터도 함께 사라진다 (컨테이너 종료는 데이터를 삭제하지 않는다)</li>
  <li>따라서 컨테이너의 생명 주기와 관계없이 데이터를 영구적으로 저장하기 위한 방법이 필요하다</li>
  <li>또한 여러 컨테이너가 데이터를 공유할 수 있으면 데이터를 컨테이너별로 중복 저장할 필요가 없어 컨테이너를 더욱 효율적으로 관리할 수 있게 될 것이다</li>
  <li>이러한 이유로 도커는 영구적인 요소와의 마운트를 다음의 두 가지 방법으로 제공한다
    <ul>
      <li>볼륨(volume)</li>
      <li>바인드(bind)</li>
    </ul>
  </li>
</ul>

<p><img src="../../images/docker_17.png" alt="" /></p>

<h1 id="volume">Volume</h1>

<p><img src="../../images/docker_18.png" alt="" /></p>

<ul>
  <li>도커 볼륨은 도커에서 스토리지를 다루는 단위다</li>
  <li>데이터베이스처럼 영구성이 필요한 애플리케이션을 컨테이너로 실행하려면 볼륨을 사용해야 한다</li>
  <li>볼륨을 사용하면 컨테이너의 데이터가 호스트 컴퓨터 내에 있는 도커에 의해 관리되는 파일 시스템(Linux기준 <code class="language-plaintext highlighter-rouge">/var/lib/docker/volumes/</code>)에 데이터가 저장된다</li>
  <li>볼륨은 <strong>완전히 도커에 의해서만 관리</strong>되어 <strong>호스트 머신의 디렉토리 구조나 OS에 독립적</strong>인, 도커에서 데이터를 유지하기 위한 권장되는 메커니즘이다</li>
  <li>볼륨 드라이버를 사용해 클라우드 또는 리모트 호스트에 데이터를 저장할 수도 있다</li>
</ul>

<div class="bell-para">
    <div class="bell-bar">
      <i class="fa-solid fa-bell"></i>
      볼륨을 사용하기 좋은 경우  
    </div>
    <div class="bell-content">
      <ul>
        <li>여러 컨테이너에 마운트하고 싶은 경우 (명시적으로 표현한 볼륨이 없으면 자동으로 생성하고 마운트 해준다)</li>
        <li>도커 호스트의 파일 구조를 모르는 경우 (bind mount와 달리 Volume은 볼륨 명으로 관리)</li>
        <li>백업, 데이터 통합이 필요한 경우</li>
      </ul>
    </div>
</div>

<h2 id="실습">실습</h2>

<h3 id="볼륨-생성">볼륨 생성</h3>

<ul>
  <li>볼륨은 도커에서 이미지나 컨테이너와 동급인 요소다</li>
</ul>

<h4 id="dockerfile-volume-인스트럭션">Dockerfile VOLUME 인스트럭션</h4>

<ul>
  <li>Dockerfile 의 <code class="language-plaintext highlighter-rouge">VOLUME</code> 인스트럭션으로 만들 수 있다</li>
  <li>하지만 이 방법은 볼륨명(source)을 지정할 수 없고, 컨테이너의 마운트 지점(target)만 지정할 수 있다</li>
  <li>Dockerfile에서 <code class="language-plaintext highlighter-rouge">VOLUME</code>의 용도는 이미지가 데이터베이스 같은 유상태 애플리케이션의 경우 사용자가 볼륨을 지정하지 않더라도 데이터를 유실하지 않기 위한 안전장치 용도이다</li>
  <li>컨테이너를 실행할 때 볼륨을 새로 정의하면 <code class="language-plaintext highlighter-rouge">VOLUME</code> 은 무시된다</li>
</ul>

<h4 id="docker-volume-명령어">docker volume 명령어</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker volume</code> 명령어를 사용해 볼륨을 만들고 확인하고 삭제할 수 있다</li>
  <li>볼륨은 <code class="language-plaintext highlighter-rouge">docker volume create</code> 명령어를 이용해 명시적으로 볼륨을 생성할 수 있다</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 볼륨 생성</span>
docker volume create my-volume

<span class="c"># 볼륨 마운트</span>
docker container run <span class="nt">-v</span> my-volume:/data &lt;이미지명&gt;
</code></pre></div></div>

<h4 id="docker-compose">docker compose</h4>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.9"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">frontend</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">node:lts</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">my-volume:/data</span> <span class="c1"># 볼륨 마운트</span>
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">my-volume</span><span class="pi">:</span> <span class="c1"># 볼륨 생성</span>
</code></pre></div></div>

<h3 id="볼륨-삭제">볼륨 삭제</h3>

<ul>
  <li>특정 볼륨을 삭제할 때는 <code class="language-plaintext highlighter-rouge">docker volume rm &lt;볼륨명&gt;</code> 명령어를 사용한다</li>
  <li>만약 사용하지 않는 불특정 볼륨들을 제거하고 싶다면 <code class="language-plaintext highlighter-rouge">docker volume prune</code> 명령어를 사용하면 된다</li>
</ul>

<h3 id="볼륨-확인">볼륨 확인</h3>

<ul>
  <li>특정 볼륨을 확인할 때는 <code class="language-plaintext highlighter-rouge">docker volume inspect &lt;볼륨명&gt;</code> 명렁어를 사용한다</li>
  <li>볼륨 목록을 확인할 때는 <code class="language-plaintext highlighter-rouge">docker volume ls</code> 명령어를 사용한다</li>
</ul>

<h3 id="볼륨-마운트">볼륨 마운트</h3>

<ul>
  <li>볼륨(바인드 포함)을 마운트 할 때는 <code class="language-plaintext highlighter-rouge">-v</code> 옵션과 <code class="language-plaintext highlighter-rouge">--mount</code> 옵션 두 가지가 있다</li>
  <li><code class="language-plaintext highlighter-rouge">-v</code>는 기존에 있던 옵션이고, <code class="language-plaintext highlighter-rouge">--mount</code>는 이 후에 나온 좀 더 명시적인 옵션이다 (도커에서 <code class="language-plaintext highlighter-rouge">--mount</code> 옵션 권장)</li>
  <li>차이점은 <code class="language-plaintext highlighter-rouge">-v</code>는 콜론(<code class="language-plaintext highlighter-rouge">:</code>)으로 값들을 구분하고, <code class="language-plaintext highlighter-rouge">--mount</code>는 키-밸류 페어로 구분해 조금 더 명시적이다</li>
  <li>바인드 마운트의 경우 <code class="language-plaintext highlighter-rouge">-v</code>는 명시한 디렉터리가 존재하지 않으면 생성하고, <code class="language-plaintext highlighter-rouge">--mount</code>는 에러를 발생한다</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-v</span> &lt;볼륨명&gt;:&lt;컨테이너 마운트 지점&gt;:&lt;옵션 ex. ro&gt; <span class="c"># 볼륨 마운트</span>
<span class="nt">-v</span> &lt;호스트 디렉터리&gt;:&lt;컨테이너 마운트 지점&gt;:&lt;옵션 ex. ro&gt; <span class="c"># 바인드 마운트</span>

<span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span>volume, <span class="nb">source</span><span class="o">=</span>&lt;볼륨명&gt;, <span class="nv">target</span><span class="o">=</span>&lt;컨테이너 마운트 지점&gt;, <span class="nb">readonly</span> <span class="c"># 볼륨 마운트</span>
<span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>, <span class="nb">source</span><span class="o">=</span>&lt;호스트 디렉터리&gt;, <span class="nv">target</span><span class="o">=</span>&lt;컨테이너 마운트 지점&gt;, <span class="nb">readonly</span> <span class="c"># 바인드 마운트</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker volume inspect my-vol

<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"Driver"</span>: <span class="s2">"local"</span>,
        <span class="s2">"Labels"</span>: <span class="o">{}</span>,
        <span class="s2">"Mountpoint"</span>: <span class="s2">"/var/lib/docker/volumes/my-vol/_data"</span>,
        <span class="s2">"Name"</span>: <span class="s2">"my-vol"</span>,
        <span class="s2">"Options"</span>: <span class="o">{}</span>,
        <span class="s2">"Scope"</span>: <span class="s2">"local"</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div></div>

<h1 id="bind-mount">Bind Mount</h1>

<p><img src="../../images/docker_19.png" alt="" /></p>

<ul>
  <li>바인드 마운트는 호스트 컴퓨터 파일 시스템의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만든다</li>
  <li>(볼륨은 볼륨명이라는 가상의 식별자를 사용하고, 바인드는 호스트 컴퓨터 파일 시스템의 절대 경로를 사용한다)</li>
  <li>바인드 마운트는 양방향으로 동작한다. 컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정할 수도 있고, 반대로 호스트에서 만든 파일도 컨테이너에서 수정할 수 있다</li>
  <li>만약 컨테이너의 마운트 경로에 이미지에서 만들어뒀던 파일이 이미 존재하는 경우, 이 파일들은 완전히 대체된다 (볼륨, 바인드 모두)</li>
  <li>컨테이너에서 호스트 파일 시스템에 접근할 수 있다는 점 때문에 보안에 안좋은 영향을 끼칠 수 있다</li>
</ul>

<div class="bell-para">
    <div class="bell-bar">
      <i class="fa-solid fa-bell"></i>
      바인드를 사용하기 좋은 경우  
    </div>
    <div class="bell-content">
      <ul>
        <li>컨테이너의 애플리케이션에 필요한 설정 파일을 호스트 컴퓨터에서 관리할 때 유용하다</li>
      </ul>
    </div>
</div>

<h2 id="실습-1">실습</h2>

<ul>
  <li>바인드는 말그대로 호스트 컴퓨터의 경로와 바인드만 하면된다. 볼륨처럼 따로 생성할 필요 없다</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-v</span> &lt;호스트 디렉터리&gt;:&lt;컨테이너 마운트 지점&gt;:&lt;옵션 ex. ro&gt; <span class="c"># -v 옵션</span>

<span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>, <span class="nb">source</span><span class="o">=</span>&lt;호스트 디렉터리&gt;, <span class="nv">target</span><span class="o">=</span>&lt;컨테이너 마운트 지점&gt;, <span class="nb">readonly</span> <span class="c"># --mount 옵션 (권장방식)</span>
</code></pre></div></div>

<h1 id="참고">참고</h1>

<ul>
  <li><a href="https://docs.docker.com/storage/" target="_blank">도커 공식문서: Manage data in Docker</a></li>
  <li><a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#volume-configuration-reference" target="_blank">도커 공식문서: Docker-compose volume configuration</a></li>
  <li><a href="https://www.daleseo.com/docker-volumes-bind-mounts/" target="_blank">DaleSeo: Docker 컨테이너에 데이터 저장 (볼륨/바인드 마운트)</a></li>
  <li><a href="https://stackoverflow.com/questions/41935435/understanding-volume-instruction-in-dockerfile" target="_blank">stack overflow: Understanding “VOLUME” instruction in DockerFile</a></li>
</ul>
:ET