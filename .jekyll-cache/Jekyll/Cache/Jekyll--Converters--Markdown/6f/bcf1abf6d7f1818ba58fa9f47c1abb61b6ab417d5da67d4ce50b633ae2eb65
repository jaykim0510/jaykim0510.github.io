I"‡$<p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#kafka-listeners" id="markdown-toc-kafka-listeners">Kafka Listeners</a></li>
  <li><a href="#why-can-i-connect-to-the-broker-but-the-client-still-fails" id="markdown-toc-why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</a></li>
  <li><a href="#how-to-connecting-to-kafka-on-docker" id="markdown-toc-how-to-connecting-to-kafka-on-docker">HOW TO: Connecting to Kafka on Docker</a></li>
</ul>

<hr />

<p><a href="https://www.confluent.io/blog/kafka-listeners-explained/">ì›ë¬¸: Confluentë¸”ë¡œê·¸</a></p>

<h1 id="kafka-listeners">Kafka Listeners</h1>

<p>ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ê°€ ì¹´í”„ì¹´ì— ì—°ê²°ë˜ê¸° ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">advertised.listeners</code>(ë˜ëŠ” ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•  ê²½ìš° <code class="language-plaintext highlighter-rouge">KAFKA_ADVERTISED_LISTENERS</code>)ë¥¼ <strong>external IP ì£¼ì†Œ</strong>ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p><img src="/images/kafka_36.png" alt="" /></p>

<p>ì•„íŒŒì¹˜ ì¹´í”„ì¹´ëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¦¬ë” íŒŒí‹°ì…˜ìœ¼ë¡œë¶€í„° ì“°ê³  ì½ì–´ì§€ë©° ë¦¬ë” íŒŒí‹°ì…˜ì€ ì–´ë–¤ ë¸Œë¡œì»¤ì—ë„ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¹´í”„ì¹´ì— ì—°ê²°ë˜ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ê³  ìˆëŠ” ë¸Œë¡œì»¤ê°€ ëˆ„êµ¬ì¸ì§€ì— ëŒ€í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. ì´ ë©”íƒ€ë°ì´í„°ì—ëŠ” ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ëŠ” ë¸Œë¡œì»¤ì˜ ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë©° í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ì •ë³´ë¥¼ ì´ìš©í•´ ì¹´í”„ì¹´ì™€ ì—°ê²°ë  ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë§Œì•½ ì¹´í”„ì¹´ê°€ ë„ì»¤ì™€ ê°™ì€ ê°€ìƒë¨¸ì‹ ì´ ì•„ë‹Œ bare metal ìœ„ì—ì„œ ë™ì‘í•œë‹¤ë©´ ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ê·¸ì € <code class="language-plaintext highlighter-rouge">hostname</code>ì´ë‚˜ <code class="language-plaintext highlighter-rouge">localhost</code> ì •ë„ê°€ ë  ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¡°ê¸ˆ ë” ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ë˜ëŠ” ë©€í‹° ë…¸ë“œ í™˜ê²½ìœ¼ë¡œ ì˜¤ê²Œ ë˜ë©´ ì¡°ê¸ˆ ë” ì£¼ì˜ê°€ í•„ìš”í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>Letâ€™s assume you have more than one network. This could be things like:</p>

<p>Docker internal network(s) plus host machine
Brokers in the cloud (e.g., AWS EC2) and on-premises machines locally (or even in another cloud)
You need to tell Kafka how the brokers can reach each other but also make sure that external clients (producers/consumers) can reach the broker they need to reach.</p>

<p>ì´ˆê¸°ì— ë¸Œë¡œì»¤ê°€ ì—°ê²°ë˜ë©´ ì‹¤ì œë¡œ ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ëŠ” ë¸Œë¡œì»¤ì˜ hostì™€ IPì˜ ì •ë³´ë¥¼ ëŒë ¤ì¤ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³¼ì •ì€ ë‹¨ì¼ ë…¸ë“œ í™˜ê²½ì—ì„œë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KAFKA_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_ADVERTISED_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_BOB:PLAINTEXT,LISTENER_FRED:PLAINTEXT
KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_BOB
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">server.properties</code></p>

<ul>
  <li><strong>KAFKA_LISTENERS</strong>: ì¹´í”„ì¹´ê°€ ë¦¬ìŠ¤ë‹í•˜ê¸° ìœ„í•´ ë…¸ì¶œí•˜ëŠ” host/IPì™€ port</li>
  <li><strong>KAFKA_ADVERTISED_LISTENERS</strong>: í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë ¤ì£¼ëŠ” ë¦¬ìŠ¤ë„ˆì˜ host/IPì™€ port ë¦¬ìŠ¤íŠ¸</li>
  <li><strong>KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</strong>: ê° ë¦¬ìŠ¤ë„ˆë“¤ì´ ì‚¬ìš©í•˜ëŠ” security protocol</li>
  <li><strong>KAFKA_INTER_BROKER_LISTENER_NAME</strong>: ë¸Œë¡œì»¤ë“¤ ê°„ì˜ í†µì‹ ì„ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ</li>
</ul>

<p>ë¸Œë¡œì»¤ì— ì—°ê²°ë˜ë©´ ì—°ê²°ëœ ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜ë©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">kafkacat</code>ì€ ì´ëŸ¬í•œ ì •ë³´ë¥¼ ì•Œì•„ë³´ëŠ” ìœ ìš©í•œ íˆ´ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">-L</code>ì„ ì´ìš©í•˜ë©´ ì—°ê²°ëœ ë¦¬ìŠ¤ë„ˆì— ê´€í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 9092í¬íŠ¸ë¡œ ì—°ê²°ì‹œ, localhost:9092 ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜</span>
<span class="nv">$ </span>kafkacat <span class="nt">-b</span> kafka0:9092 <span class="se">\</span>
           <span class="nt">-L</span>
Metadata <span class="k">for </span>all topics <span class="o">(</span>from broker <span class="nt">-1</span>: kafka0:9092/bootstrap<span class="o">)</span>:
1 brokers:
  broker 0 at localhost:9092
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 29092í¬íŠ¸ë¡œ ì—°ê²°ì‹œ, kafka0:29092 ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜</span>
<span class="nv">$ </span>kafkacat <span class="nt">-b</span> kafka0:29092 <span class="se">\</span>
           <span class="nt">-L</span>
Metadata <span class="k">for </span>all topics <span class="o">(</span>from broker 0: kafka0:29092/0<span class="o">)</span>:
1 brokers:
  broker 0 at kafka0:29092
</code></pre></div></div>

<h1 id="why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</h1>

<p>ì´ˆê¸° ë¸Œë¡œì»¤ ì—°ê²°ì— ì„±ê³µí–ˆë‹¤ê³  í•˜ë”ë¼ë„, ë¸Œë¡œì»¤ê°€ ë°˜í™˜í•˜ëŠ” ë©”íƒ€ë°ì´í„° ì•ˆì— ìˆëŠ” ì£¼ì†Œë¡œ ì—¬ì „íˆ í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ê·¼í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì— ë¸Œë¡œì»¤ë¥¼ ë§Œë“¤ì–´ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ EC2ì— ìˆëŠ” ë¸Œë¡œì»¤ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. external hostnameì€ <code class="language-plaintext highlighter-rouge">ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code>ì…ë‹ˆë‹¤. ë¡œì»¬ ë¨¸ì‹ ê³¼ EC2ê°€ í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìš°ë¦¬ì˜ ë¡œì»¬ ë¨¸ì‹ ì€ <code class="language-plaintext highlighter-rouge">ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code>ì„ <code class="language-plaintext highlighter-rouge">54.191.84.122</code>ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ë¦¬ì¡¸ë¸Œ(resolve) í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kafkacat -b ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 -L
Metadata for all topics (from broker -1: ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092/bootstrap):
1 brokers:
  broker 0 at ip-172-31-18-160.us-west-2.compute.internal:9092
</code></pre></div></div>

<ul>
  <li>
    <p>hostnameì´ <code class="language-plaintext highlighter-rouge">ip-172-31-18-160.us-west-2.compute.internal</code>ì¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì§€ë§Œ ì¸í„°ë„·ì„ í†µí•´ <code class="language-plaintext highlighter-rouge">ip-172-31-18-160.us-west-2.compute.internal</code>ì€ not resolvableí•´ì„œ í´ë¼ì´ì–¸íŠ¸ëŠ” ë¸Œë¡œì»¤ì— ë©”ì„¸ì§€ ì „ì†¡ì„ ì‹¤íŒ¨í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo "test"|kafka-console-producer --broker-list ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test
&gt;&gt;[2018-07-30 15:08:41,932] ERROR Error when sending message to topic test with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)
org.apache.kafka.common.errors.TimeoutException: Expiring 1 record(s) for test-0: 1547 ms has passed since batch creation plus linger time
</code></pre></div></div>

<ul>
  <li>ë¸Œë¡œì»¤ê°€ ì„¤ì¹˜ëœ ì„œë²„ì˜ í´ë¼ì´ì–¸íŠ¸ë¡œëŠ” ë¬¸ì œì—†ì´ ë™ì‘í•œë‹¤.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo "foo"|kafka-console-producer --broker-list ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test
&gt;&gt;
$ kafka-console-consumer --bootstrap-server ec2-54-191-84-122.us-west-2.compute.amazonaws.com:9092 --topic test --from-beginning
foo
</code></pre></div></div>
<p>ì´ëŸ¬í•œ ì¼ì´ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” 9092í¬íŠ¸ë¡œ ì—°ê²°í•˜ëŠ” ë¦¬ìŠ¤ë„ˆê°€ ë‚´ë¶€ ë¦¬ìŠ¤ë„ˆì´ê¸° ë•Œë¬¸ì´ë¼ê³  í•œë‹¤. ê·¸ë˜ì„œ ë¸Œë¡œì»¤ê°€ ì„¤ì¹˜ëœ ì„œë²„ì˜ ë‚´ë¶€ì—ì„œë§Œ resolvableí•œ hostnameì¸ <code class="language-plaintext highlighter-rouge">ip-172-31-18-160.us-west-2.compute.internal</code>ì„ ë¦¬í„´í•œë‹¤.</p>

<h1 id="how-to-connecting-to-kafka-on-docker">HOW TO: Connecting to Kafka on Docker</h1>

<p><img src="/images/kafka_36.png" alt="" /></p>

<p>ë„ì»¤ì—ì„œ ë™ì‘í•˜ê¸° ìœ„í•´ì„œëŠ” ì¹´í”„ì¹´ì˜ ë‘ ê°œì˜ listenerë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>Communication within the Docker network: This could be inter-broker communication (i.e., between brokers) and between other components running in Docker, such as Kafka Connect or third-party clients or producers.For these comms, we need to use the hostname of the Docker container(s). Each Docker container on the same Docker network will use the hostname of the Kafka broker container to reach it.</p>
  </li>
  <li>
    <p>Non-Docker network traffic: This could be clients running locally on the Docker host machine, for example. The assumption is that they will connect on localhost to a port exposed from the Docker container.Hereâ€™s the Docker Compose snippet:</p>
  </li>
</ul>
:ET