I"1À<hr />

<p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#operations" id="markdown-toc-operations">Operations</a>    <ul>
      <li><a href="#filter" id="markdown-toc-filter">Filter</a></li>
      <li><a href="#groupby" id="markdown-toc-groupby">GroupBy</a></li>
      <li><a href="#join" id="markdown-toc-join">Join</a>        <ul>
          <li><a href="#stream-batch-join" id="markdown-toc-stream-batch-join">Stream-Batch Join</a></li>
          <li><a href="#stream-stream-join" id="markdown-toc-stream-stream-join">Stream-Stream Join</a></li>
        </ul>
      </li>
      <li><a href="#udf" id="markdown-toc-udf">UDF</a></li>
      <li><a href="#window" id="markdown-toc-window">Window</a>        <ul>
          <li><a href="#tumbling-window" id="markdown-toc-tumbling-window">Tumbling window</a></li>
          <li><a href="#sliding-window" id="markdown-toc-sliding-window">Sliding window</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#watermark" id="markdown-toc-watermark">Watermark</a></li>
  <li><a href="#ì°¸ê³ " id="markdown-toc-ì°¸ê³ ">ì°¸ê³ </a></li>
</ul>

<hr />

<h1 id="operations">Operations</h1>

<p>We can perform various operations on a streaming DataFrame like select, filter, groupBy, join, window, UDF, map, flatMap, etc.</p>

<h2 id="filter">Filter</h2>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"Date"</span><span class="p">,</span> <span class="s">"Open"</span><span class="p">,</span> <span class="s">"Close"</span><span class="p">)</span> \
              <span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Close"</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Open"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----+----------+-----+-----+</span>
<span class="o">|</span><span class="n">Name</span><span class="o">|</span>      <span class="n">Date</span><span class="o">|</span> <span class="n">Open</span><span class="o">|</span><span class="n">Close</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="o">|</span><span class="mf">10.34</span><span class="o">|</span><span class="mf">10.68</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">|</span><span class="mf">10.75</span><span class="o">|</span> <span class="mf">10.9</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">10.89</span><span class="o">|</span><span class="mf">11.55</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="o">|</span><span class="mf">11.98</span><span class="o">|</span><span class="mf">11.99</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span><span class="mf">12.14</span><span class="o">|</span><span class="mf">12.23</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">10.87</span><span class="o">|</span> <span class="mf">11.1</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span><span class="o">|</span><span class="mf">10.17</span><span class="o">|</span><span class="mf">10.71</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="o">|</span><span class="mf">10.71</span><span class="o">|</span><span class="mf">10.77</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span><span class="o">|</span> <span class="mf">9.78</span><span class="o">|</span> <span class="mf">9.83</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span> <span class="mf">9.31</span><span class="o">|</span> <span class="mf">9.62</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">14</span><span class="o">|</span>  <span class="mf">9.3</span><span class="o">|</span> <span class="mf">9.66</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">15</span><span class="o">|</span> <span class="mf">9.59</span><span class="o">|</span> <span class="mf">9.89</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span><span class="o">|</span> <span class="mf">9.99</span><span class="o">|</span><span class="mf">10.08</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">22</span><span class="o">|</span> <span class="mf">9.86</span><span class="o">|</span><span class="mf">10.19</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span><span class="o">|</span> <span class="mf">9.83</span><span class="o">|</span> <span class="mf">9.87</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span> <span class="mf">9.86</span><span class="o">|</span> <span class="mf">9.94</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">07</span><span class="o">|</span> <span class="mf">9.39</span><span class="o">|</span> <span class="mf">9.47</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span> <span class="mf">9.29</span><span class="o">|</span> <span class="mf">9.38</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span><span class="o">|</span>  <span class="mf">9.4</span><span class="o">|</span> <span class="mf">9.62</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span><span class="o">|</span> <span class="mf">8.45</span><span class="o">|</span>  <span class="mf">8.9</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+</span>
</code></pre></div></div>

<h2 id="groupby">GroupBy</h2>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span><span class="s">"Date"</span><span class="p">,</span> <span class="s">"Open"</span><span class="p">,</span> <span class="s">"High"</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">)</span> \
  <span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Name"</span><span class="p">),</span> <span class="n">F</span><span class="p">.</span><span class="n">year</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Date"</span><span class="p">)).</span><span class="n">alias</span><span class="p">(</span><span class="s">"YEAR"</span><span class="p">))</span> \
  <span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="s">"High"</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"Highest"</span><span class="p">)).</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"timestamp"</span><span class="p">,</span> <span class="n">F</span><span class="p">.</span><span class="n">current_date</span><span class="p">().</span><span class="n">cast</span><span class="p">(</span><span class="s">"string"</span><span class="p">))</span>
<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----+----+-------+----------+</span>
<span class="o">|</span><span class="n">Name</span><span class="o">|</span><span class="n">YEAR</span><span class="o">|</span><span class="n">Highest</span><span class="o">|</span> <span class="n">timestamp</span><span class="o">|</span>
<span class="o">+----+----+-------+----------+</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2017</span><span class="o">|</span>  <span class="mf">177.2</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2014</span><span class="o">|</span> <span class="mf">119.75</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">|</span>  <span class="mf">13.31</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2008</span><span class="o">|</span>  <span class="mf">28.61</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2012</span><span class="o">|</span> <span class="mf">100.72</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2009</span><span class="o">|</span>  <span class="mf">30.56</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2011</span><span class="o">|</span>  <span class="mf">60.96</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2016</span><span class="o">|</span> <span class="mf">118.69</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2015</span><span class="o">|</span> <span class="mf">134.54</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2013</span><span class="o">|</span>  <span class="mf">82.16</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2010</span><span class="o">|</span>  <span class="mf">46.67</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2007</span><span class="o">|</span>  <span class="mf">28.99</span><span class="o">|</span><span class="mi">2023</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span>
<span class="o">+----+----+-------+----------+</span>
</code></pre></div></div>

<h2 id="join">Join</h2>

<h3 id="stream-batch-join">Stream-Batch Join</h3>

<p>With stream-batch joins, we can join a batch DataFrame with a streaming DataFrame. Letâs discuss with an example.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">company_df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"csv"</span><span class="p">).</span><span class="n">option</span><span class="p">(</span><span class="s">"path"</span><span class="p">,</span> <span class="s">"hdfs://hdfs-name-node:8020/static/company.csv"</span><span class="p">).</span><span class="n">option</span><span class="p">(</span><span class="s">"header"</span><span class="p">,</span> <span class="bp">True</span><span class="p">).</span><span class="n">load</span><span class="p">()</span>
<span class="n">company_df</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
<span class="o">-------</span>
<span class="o">+-----+---------------+</span>
<span class="o">|</span> <span class="n">Name</span><span class="o">|</span><span class="n">FullCompanyName</span><span class="o">|</span>
<span class="o">+-----+---------------+</span>
<span class="o">|</span> <span class="n">AAPL</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span> <span class="n">AMZN</span><span class="o">|</span>         <span class="n">Amazon</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">+-----+---------------+</span>
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inner, left_outer, right_outer
</span><span class="n">join_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">company_df</span><span class="p">,</span> <span class="s">"Name"</span><span class="p">,</span> <span class="s">"inner"</span><span class="p">)</span>

<span class="n">join_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"append"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>
<span class="o">------------------------------------------------------------</span>
<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----+----------+-----+-----+---------------+</span>
<span class="o">|</span><span class="n">Name</span><span class="o">|</span>      <span class="n">Date</span><span class="o">|</span> <span class="n">Open</span><span class="o">|</span><span class="n">Close</span><span class="o">|</span><span class="n">FullCompanyName</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+---------------+</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="o">|</span><span class="mf">10.34</span><span class="o">|</span><span class="mf">10.68</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">|</span><span class="mf">10.75</span><span class="o">|</span> <span class="mf">10.9</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">10.89</span><span class="o">|</span><span class="mf">11.55</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="o">|</span><span class="mf">11.98</span><span class="o">|</span><span class="mf">11.99</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span><span class="mf">12.14</span><span class="o">|</span><span class="mf">12.23</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">10.87</span><span class="o">|</span> <span class="mf">11.1</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span><span class="o">|</span><span class="mf">10.17</span><span class="o">|</span><span class="mf">10.71</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="o">|</span><span class="mf">10.71</span><span class="o">|</span><span class="mf">10.77</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span><span class="o">|</span> <span class="mf">9.78</span><span class="o">|</span> <span class="mf">9.83</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span> <span class="mf">9.31</span><span class="o">|</span> <span class="mf">9.62</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">14</span><span class="o">|</span>  <span class="mf">9.3</span><span class="o">|</span> <span class="mf">9.66</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">15</span><span class="o">|</span> <span class="mf">9.59</span><span class="o">|</span> <span class="mf">9.89</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span><span class="o">|</span> <span class="mf">9.99</span><span class="o">|</span><span class="mf">10.08</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">22</span><span class="o">|</span> <span class="mf">9.86</span><span class="o">|</span><span class="mf">10.19</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span><span class="o">|</span> <span class="mf">9.83</span><span class="o">|</span> <span class="mf">9.87</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span> <span class="mf">9.86</span><span class="o">|</span> <span class="mf">9.94</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">07</span><span class="o">|</span> <span class="mf">9.39</span><span class="o">|</span> <span class="mf">9.47</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span> <span class="mf">9.29</span><span class="o">|</span> <span class="mf">9.38</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span><span class="o">|</span>  <span class="mf">9.4</span><span class="o">|</span> <span class="mf">9.62</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">|</span><span class="n">AAPL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span><span class="o">|</span> <span class="mf">8.45</span><span class="o">|</span>  <span class="mf">8.9</span><span class="o">|</span>          <span class="n">Apple</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+---------------+</span>

<span class="c1"># inner join ì´ê¸° ëë¬¸ì MSFT.csv ë°ì´í°ë¥¼ ë£ììëë ìëì¨ë¤
</span><span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----+----+----+-----+---------------+</span>
<span class="o">|</span><span class="n">Name</span><span class="o">|</span><span class="n">Date</span><span class="o">|</span><span class="n">Open</span><span class="o">|</span><span class="n">Close</span><span class="o">|</span><span class="n">FullCompanyName</span><span class="o">|</span>
<span class="o">+----+----+----+-----+---------------+</span>
<span class="o">+----+----+----+-----+---------------+</span>

<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">2</span>
<span class="o">-------------------------------------------</span>
<span class="o">+-----+----------+------+------+---------------+</span>
<span class="o">|</span> <span class="n">Name</span><span class="o">|</span>      <span class="n">Date</span><span class="o">|</span>  <span class="n">Open</span><span class="o">|</span> <span class="n">Close</span><span class="o">|</span><span class="n">FullCompanyName</span><span class="o">|</span>
<span class="o">+-----+----------+------+------+---------------+</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="o">|</span><span class="mf">211.47</span><span class="o">|</span><span class="mf">217.83</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="o">|</span><span class="mf">222.17</span><span class="o">|</span><span class="mf">222.84</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="o">|</span><span class="mf">223.22</span><span class="o">|</span><span class="mf">225.85</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">|</span><span class="mf">228.66</span><span class="o">|</span><span class="mf">233.06</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span><span class="o">|</span><span class="mf">233.44</span><span class="o">|</span><span class="mf">233.68</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">232.44</span><span class="o">|</span><span class="mf">235.11</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="o">|</span><span class="mf">235.87</span><span class="o">|</span><span class="mf">236.05</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span><span class="mf">232.39</span><span class="o">|</span><span class="mf">233.36</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span><span class="o">|</span><span class="mf">231.76</span><span class="o">|</span><span class="mf">233.79</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">203.89</span><span class="o">|</span><span class="mf">213.96</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span><span class="o">|</span><span class="mf">218.23</span><span class="o">|</span><span class="mf">221.74</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span><span class="o">|</span> <span class="mf">215.5</span><span class="o">|</span><span class="mf">216.55</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="o">|</span><span class="mf">194.71</span><span class="o">|</span><span class="mf">201.09</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span><span class="o">|</span><span class="mf">184.42</span><span class="o">|</span><span class="mf">184.72</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">181.16</span><span class="o">|</span><span class="mf">181.49</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">15</span><span class="o">|</span><span class="mf">170.81</span><span class="o">|</span><span class="mf">171.36</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span><span class="o">|</span><span class="mf">173.01</span><span class="o">|</span><span class="mf">183.41</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span><span class="o">|</span> <span class="mf">183.4</span><span class="o">|</span><span class="mf">183.48</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">182.99</span><span class="o">|</span><span class="mf">189.22</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">24</span><span class="o">|</span><span class="mf">188.84</span><span class="o">|</span><span class="mf">188.89</span><span class="o">|</span>         <span class="n">Google</span><span class="o">|</span>
<span class="o">+-----+----------+------+------+---------------+</span>
</code></pre></div></div>

<h3 id="stream-stream-join">Stream-Stream Join</h3>

<p><code class="language-plaintext highlighter-rouge">left_outer</code> and <code class="language-plaintext highlighter-rouge">right_outer</code> joins are conditionally supported with watermark but full_outer join is not supported.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">readStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"csv"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"path"</span><span class="p">,</span> <span class="s">"hdfs://hdfs-name-node:8020/data"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"maxFilesPerTrigger"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"header"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="n">schema</span><span class="p">).</span><span class="n">load</span><span class="p">()</span>

<span class="n">stream_df_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span><span class="s">"Date"</span><span class="p">,</span> <span class="s">"High"</span><span class="p">)</span>
<span class="n">stream_df_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span><span class="s">"Date"</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">)</span>

<span class="n">join_df</span> <span class="o">=</span> <span class="n">stream_df_high</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">stream_df_low</span><span class="p">,</span> <span class="p">[</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"Date"</span><span class="p">])</span>

<span class="n">join_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"append"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>
<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+-----+----------+-------+-------+</span>
<span class="o">|</span> <span class="n">Name</span><span class="o">|</span>      <span class="n">Date</span><span class="o">|</span>   <span class="n">High</span><span class="o">|</span>    <span class="n">Low</span><span class="o">|</span>
<span class="o">+-----+----------+-------+-------+</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span><span class="o">|</span>  <span class="mf">180.2</span><span class="o">|</span> <span class="mf">175.45</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">29</span><span class="o">|</span> <span class="mf">191.35</span><span class="o">|</span> <span class="mf">188.79</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2007</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">17</span><span class="o">|</span> <span class="mf">348.06</span><span class="o">|</span> <span class="mf">332.17</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2008</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">03</span><span class="o">|</span> <span class="mf">237.38</span><span class="o">|</span> <span class="mf">230.02</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span><span class="o">|</span> <span class="mf">275.27</span><span class="o">|</span> <span class="mf">269.39</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">29</span><span class="o">|</span> <span class="mf">232.51</span><span class="o">|</span> <span class="mf">225.79</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2011</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">09</span><span class="o">|</span> <span class="mf">310.03</span><span class="o">|</span> <span class="mf">306.48</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2011</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span><span class="o">|</span> <span class="mf">312.81</span><span class="o">|</span> <span class="mf">306.81</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2011</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">14</span><span class="o">|</span> <span class="mf">290.01</span><span class="o">|</span> <span class="mf">286.34</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span> <span class="mf">595.59</span><span class="o">|</span> <span class="mf">591.28</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2014</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span> <span class="mf">593.72</span><span class="o">|</span> <span class="mf">587.14</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2014</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">06</span><span class="o">|</span>  <span class="mf">556.8</span><span class="o">|</span> <span class="mf">550.58</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2014</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">25</span><span class="o">|</span>  <span class="mf">552.5</span><span class="o">|</span> <span class="mf">546.91</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span><span class="o">|</span>  <span class="mf">508.6</span><span class="o">|</span> <span class="mf">498.65</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2015</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span> <span class="mf">561.84</span><span class="o">|</span> <span class="mf">555.53</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span>  <span class="mf">765.8</span><span class="o">|</span> <span class="mf">755.86</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span> <span class="mf">807.19</span><span class="o">|</span> <span class="mf">803.64</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span>  <span class="mf">801.0</span><span class="o">|</span> <span class="mf">795.99</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span><span class="mf">1014.76</span><span class="o">|</span><span class="mf">1007.06</span><span class="o">|</span>
<span class="o">|</span><span class="n">GOOGL</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">24</span><span class="o">|</span> <span class="mf">190.23</span><span class="o">|</span> <span class="mf">186.93</span><span class="o">|</span>
<span class="o">+-----+----------+-------+-------+</span>

<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----+----------+-----+-----+</span>
<span class="o">|</span><span class="n">Name</span><span class="o">|</span>      <span class="n">Date</span><span class="o">|</span> <span class="n">High</span><span class="o">|</span>  <span class="n">Low</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2007</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">29.28</span><span class="o">|</span><span class="mf">28.89</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2007</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span><span class="mf">28.62</span><span class="o">|</span><span class="mf">28.04</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2008</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">04</span><span class="o">|</span><span class="mf">30.72</span><span class="o">|</span><span class="mf">30.11</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2008</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">26</span><span class="o">|</span><span class="mf">27.56</span><span class="o">|</span><span class="mf">26.14</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2008</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">30</span><span class="o">|</span><span class="mf">23.88</span><span class="o">|</span><span class="mf">22.39</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">22</span><span class="o">|</span><span class="mf">19.19</span><span class="o">|</span> <span class="mf">18.7</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">24</span><span class="o">|</span> <span class="mf">21.2</span><span class="o">|</span> <span class="mf">19.5</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span><span class="o">|</span><span class="mf">28.08</span><span class="o">|</span><span class="mf">27.57</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">26</span><span class="o">|</span><span class="mf">24.19</span><span class="o">|</span><span class="mf">23.79</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2010</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span><span class="o">|</span><span class="mf">27.92</span><span class="o">|</span><span class="mf">27.63</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2011</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">22</span><span class="o">|</span><span class="mf">25.65</span><span class="o">|</span> <span class="mf">24.6</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2012</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">26.97</span><span class="o">|</span><span class="mf">26.52</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2013</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">35.65</span><span class="o">|</span><span class="mf">35.14</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2013</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="o">|</span> <span class="mf">33.4</span><span class="o">|</span><span class="mf">32.83</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2014</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">04</span><span class="o">|</span><span class="mf">47.73</span><span class="o">|</span><span class="mf">47.25</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">05</span><span class="o">|</span><span class="mf">28.11</span><span class="o">|</span><span class="mf">27.78</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">04</span><span class="o">|</span> <span class="mf">16.4</span><span class="o">|</span><span class="mf">15.89</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span><span class="o">|</span><span class="mf">24.85</span><span class="o">|</span><span class="mf">24.29</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">26.25</span><span class="o">|</span><span class="mf">25.64</span><span class="o">|</span>
<span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mi">2009</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">02</span><span class="o">|</span><span class="mf">29.99</span><span class="o">|</span><span class="mf">29.65</span><span class="o">|</span>
<span class="o">+----+----------+-----+-----+</span>
</code></pre></div></div>

<h2 id="udf">UDF</h2>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">readStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"csv"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"path"</span><span class="p">,</span> <span class="s">"hdfs://hdfs-name-node:8020/data"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"maxFilesPerTrigger"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"header"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">schema</span><span class="p">(</span><span class="n">schema</span><span class="p">).</span><span class="n">load</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">up_down</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Up"</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Down"</span>
    <span class="k">return</span> <span class="s">"Same"</span>

<span class="n">UDF_up_down</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">udf</span><span class="p">(</span><span class="n">up_down</span><span class="p">)</span>

<span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"Up/Down"</span><span class="p">,</span> <span class="n">UDF_up_down</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Open"</span><span class="p">),</span> <span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Close"</span><span class="p">)))</span>

<span class="n">result_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"append"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>

<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+----------+-----+-----+-----+-----+---------+----+-------+</span>
<span class="o">|</span>      <span class="n">Date</span><span class="o">|</span> <span class="n">Open</span><span class="o">|</span> <span class="n">High</span><span class="o">|</span>  <span class="n">Low</span><span class="o">|</span><span class="n">Close</span><span class="o">|</span>   <span class="n">Volume</span><span class="o">|</span><span class="n">Name</span><span class="o">|</span><span class="n">Up</span><span class="o">/</span><span class="n">Down</span><span class="o">|</span>
<span class="o">+----------+-----+-----+-----+-----+---------+----+-------+</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="o">|</span><span class="mf">26.25</span><span class="o">|</span> <span class="mf">27.0</span><span class="o">|</span> <span class="mf">26.1</span><span class="o">|</span><span class="mf">26.84</span><span class="o">|</span> <span class="mi">79974418</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="o">|</span><span class="mf">26.77</span><span class="o">|</span><span class="mf">27.08</span><span class="o">|</span><span class="mf">26.77</span><span class="o">|</span><span class="mf">26.97</span><span class="o">|</span> <span class="mi">57975661</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="o">|</span><span class="mf">26.96</span><span class="o">|</span><span class="mf">27.13</span><span class="o">|</span><span class="mf">26.91</span><span class="o">|</span><span class="mf">26.99</span><span class="o">|</span> <span class="mi">48247610</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="o">|</span><span class="mf">26.89</span><span class="o">|</span> <span class="mf">27.0</span><span class="o">|</span><span class="mf">26.49</span><span class="o">|</span><span class="mf">26.91</span><span class="o">|</span><span class="mi">100969092</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span><span class="o">|</span><span class="mf">26.93</span><span class="o">|</span><span class="mf">27.07</span><span class="o">|</span><span class="mf">26.76</span><span class="o">|</span><span class="mf">26.86</span><span class="o">|</span> <span class="mi">55627836</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="o">|</span><span class="mf">26.65</span><span class="o">|</span><span class="mf">27.02</span><span class="o">|</span><span class="mf">26.59</span><span class="o">|</span> <span class="mf">27.0</span><span class="o">|</span> <span class="mi">64924946</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="o">|</span><span class="mf">27.01</span><span class="o">|</span><span class="mf">27.39</span><span class="o">|</span> <span class="mf">26.9</span><span class="o">|</span><span class="mf">27.29</span><span class="o">|</span> <span class="mi">70123544</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="o">|</span><span class="mf">27.25</span><span class="o">|</span><span class="mf">27.26</span><span class="o">|</span><span class="mf">26.97</span><span class="o">|</span><span class="mf">27.14</span><span class="o">|</span> <span class="mi">45994725</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="o">|</span><span class="mf">27.03</span><span class="o">|</span><span class="mf">27.25</span><span class="o">|</span><span class="mf">27.01</span><span class="o">|</span><span class="mf">27.19</span><span class="o">|</span> <span class="mi">41449046</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span><span class="o">|</span> <span class="mf">26.9</span><span class="o">|</span><span class="mf">27.19</span><span class="o">|</span> <span class="mf">26.9</span><span class="o">|</span><span class="mf">26.99</span><span class="o">|</span> <span class="mi">58574807</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">18</span><span class="o">|</span><span class="mf">26.74</span><span class="o">|</span><span class="mf">26.98</span><span class="o">|</span> <span class="mf">26.7</span><span class="o">|</span><span class="mf">26.83</span><span class="o">|</span> <span class="mi">52495587</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">19</span><span class="o">|</span><span class="mf">26.87</span><span class="o">|</span><span class="mf">27.24</span><span class="o">|</span><span class="mf">26.85</span><span class="o">|</span><span class="mf">27.02</span><span class="o">|</span> <span class="mi">60382450</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span><span class="o">|</span><span class="mf">27.01</span><span class="o">|</span><span class="mf">27.01</span><span class="o">|</span><span class="mf">26.26</span><span class="o">|</span><span class="mf">26.41</span><span class="o">|</span> <span class="mi">79228490</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span><span class="o">|</span><span class="mf">26.41</span><span class="o">|</span><span class="mf">26.53</span><span class="o">|</span> <span class="mf">26.3</span><span class="o">|</span><span class="mf">26.35</span><span class="o">|</span> <span class="mi">47971611</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span><span class="o">|</span><span class="mf">26.34</span><span class="o">|</span><span class="mf">26.45</span><span class="o">|</span><span class="mf">26.22</span><span class="o">|</span><span class="mf">26.28</span><span class="o">|</span> <span class="mi">63061743</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">25</span><span class="o">|</span><span class="mf">26.41</span><span class="o">|</span><span class="mf">26.57</span><span class="o">|</span><span class="mf">26.23</span><span class="o">|</span> <span class="mf">26.4</span><span class="o">|</span> <span class="mi">59072711</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">26</span><span class="o">|</span><span class="mf">26.56</span><span class="o">|</span><span class="mf">26.72</span><span class="o">|</span><span class="mf">26.31</span><span class="o">|</span> <span class="mf">26.5</span><span class="o">|</span> <span class="mi">69531321</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>   <span class="n">Down</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span><span class="o">|</span><span class="mf">27.23</span><span class="o">|</span><span class="mf">27.95</span><span class="o">|</span><span class="mf">27.19</span><span class="o">|</span><span class="mf">27.79</span><span class="o">|</span><span class="mi">134525193</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span><span class="o">|</span><span class="mf">27.82</span><span class="o">|</span><span class="mf">28.18</span><span class="o">|</span><span class="mf">27.78</span><span class="o">|</span> <span class="mf">28.0</span><span class="o">|</span><span class="mi">103999604</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">|</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span><span class="o">|</span><span class="mf">27.91</span><span class="o">|</span><span class="mf">28.38</span><span class="o">|</span><span class="mf">27.87</span><span class="o">|</span><span class="mf">28.15</span><span class="o">|</span> <span class="mi">94844406</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span>     <span class="n">Up</span><span class="o">|</span>
<span class="o">+----------+-----+-----+-----+-----+---------+----+-------+</span>
</code></pre></div></div>

<h2 id="window">Window</h2>

<p>Window operations are very similar to <code class="language-plaintext highlighter-rouge">groupBy</code> operations. In <code class="language-plaintext highlighter-rouge">groupBy</code>, aggregation is based on the specified group or key while in <code class="language-plaintext highlighter-rouge">window</code> operations, aggregation is based on event windows. Spark supports 2 types of windows Tumbling window and Sliding window.</p>

<p>Letâs discuss each one of them in detail. Take an example of numbers from 1â10 and we will calculate <code class="language-plaintext highlighter-rouge">SUM</code> using different window operations.</p>

<h3 id="tumbling-window">Tumbling window</h3>

<p>Tumbling windows are non-overlapping which means each data point will be part of only one window.</p>

<p><img src="/images/spark_stream_4.png" alt="" /></p>

<p>Here the size of the window is 2 and we have 5 non-overlapping windows along with the sum of the elements in each window. Also, we can verify that none of the elements are overlapping between windows.</p>

<p>Now let us define one in our streaming application. We can use a window function and specify the <code class="language-plaintext highlighter-rouge">DateTime</code> column and window duration say <code class="language-plaintext highlighter-rouge">2 minutes</code> or <code class="language-plaintext highlighter-rouge">30 seconds</code> or <code class="language-plaintext highlighter-rouge">1 hour</code> or <code class="language-plaintext highlighter-rouge">5 days</code> etc.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"Date"</span><span class="p">,</span> <span class="s">"Open"</span><span class="p">,</span> <span class="s">"High"</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">)</span> \
              <span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">window</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Date"</span><span class="p">),</span> <span class="s">"10 days"</span><span class="p">),</span> <span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Name"</span><span class="p">))</span> \
              <span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="s">"High"</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"Max"</span><span class="p">)).</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"window"</span><span class="p">))</span>

<span class="n">result_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"complete"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"truncate"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>

<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+------------------------------------------+----+-----+</span>
<span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">Name</span><span class="o">|</span><span class="n">Max</span>  <span class="o">|</span>
<span class="o">+------------------------------------------+----+-----+</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.39</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.26</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.38</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.07</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">26.93</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.3</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.5</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.22</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.54</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.94</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.5</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.63</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">25.0</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">24.0</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">23.92</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">22.99</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">22.76</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">23.65</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">23.72</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">23.46</span><span class="o">|</span>
<span class="o">+------------------------------------------+----+-----+</span>
</code></pre></div></div>

<h3 id="sliding-window">Sliding window</h3>

<p>As its name suggests, this window will slide instead of tumbling on the data. We can specify the level of sliding needed. These are overlapping windows. Letâs first try to understand with a simple example of numbers from 1â10.</p>

<p><img src="/images/spark_stream_5.png" alt="" /></p>

<p>Here we have defined the window size as 3 and slide interval as 2. As we can see in the snapshot above, these windows overlap. For example, the number 3 is present in both windows 1 and 2.</p>

<p>To define a sliding window, along with <code class="language-plaintext highlighter-rouge">DateTime</code> and <code class="language-plaintext highlighter-rouge">Window Size</code> in the window function, we specify <code class="language-plaintext highlighter-rouge">slide Duration</code> as the third argument. Letâs try to perform a sliding window operation in our streaming application.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"Date"</span><span class="p">,</span> <span class="s">"Open"</span><span class="p">,</span> <span class="s">"High"</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">)</span> \
              <span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">window</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Date"</span><span class="p">),</span> <span class="s">"10 days"</span><span class="p">,</span> <span class="s">"5 days"</span><span class="p">),</span> <span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"Name"</span><span class="p">))</span> \
              <span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="s">"High"</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"Max"</span><span class="p">)).</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"window"</span><span class="p">))</span>

<span class="n">result_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"complete"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"truncate"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>

<span class="o">-------------------------------------------</span>
<span class="n">Batch</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">-------------------------------------------</span>
<span class="o">+------------------------------------------+----+-----+</span>
<span class="o">|</span><span class="n">window</span>                                    <span class="o">|</span><span class="n">Name</span><span class="o">|</span><span class="n">Max</span>  <span class="o">|</span>
<span class="o">+------------------------------------------+----+-----+</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2005</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.13</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.39</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.39</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.26</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.24</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.38</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">06</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.38</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.07</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">06</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.54</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">26.93</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">26</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">26.9</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.3</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">26</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.3</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.5</span> <span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.66</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.22</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">28.22</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.54</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">07</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.94</span><span class="o">|</span>
<span class="o">|</span><span class="p">{</span><span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">}</span><span class="o">|</span><span class="n">MSFT</span><span class="o">|</span><span class="mf">27.94</span><span class="o">|</span>
<span class="o">+------------------------------------------+----+-----+</span>
</code></pre></div></div>

<h1 id="watermark">Watermark</h1>

<p>We can use <code class="language-plaintext highlighter-rouge">watermarking</code> to handle late data so that the system discards records automatically.</p>

<p>Now letâs add <code class="language-plaintext highlighter-rouge">withWatermark()</code> to our application and see how it works. We set watermark to <code class="language-plaintext highlighter-rouge">delayThreshold = 10 minutes</code> as well as <code class="language-plaintext highlighter-rouge">windowDuration = 5 minutes</code> using <code class="language-plaintext highlighter-rouge">groupBy()</code>. Watermark is set to <code class="language-plaintext highlighter-rouge">max event time seen so far â delayThreshold</code>.</p>

<p>(ìì í ë°ì´í°ì¤ ì´ë²¤í¸ ìê°ì´ ê°ì¥ í° ê°ì´ 2022-12-27 10:30:00 ì´ë¼ë©´, ìí°ë§í¬ë 2022-12-27 10:20:00ì ì°íë¤. -&gt; 10:20:00 ì´ì ì ë°ìí ë°ì´í°ë ìì íëë¼ë ì²ë¦¬íì§ ìê² ë¤ë ìë¯¸ì´ë¤. -&gt; 10:15:00 ~ 10:20:00 ìëì°ìì ì¶ë ¥ëë ê°ì ë ì´ì ìë°ì´í¸ íì§ ìê² ë¤ë ìë¯¸ì´ë¤.)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-lk</span> 9999

2023-01-01 10:06:00#2
2023â01â01 10:13:00#5
2022â12â31 10:06:00#1
2023â01â01 10:08:00#8
</code></pre></div></div>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">readStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"socket"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"host"</span><span class="p">,</span> <span class="s">"127.0.0.1"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"port"</span><span class="p">,</span> <span class="s">"9999"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">load</span><span class="p">()</span>

<span class="n">event_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"value"</span><span class="p">),</span> <span class="s">"#"</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"data"</span><span class="p">))</span> \
  <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"event_timestamp"</span><span class="p">,</span> <span class="n">F</span><span class="p">.</span><span class="n">element_at</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"data"</span><span class="p">),</span> <span class="mi">1</span><span class="p">).</span><span class="n">cast</span><span class="p">(</span><span class="s">"timestamp"</span><span class="p">))</span> \
  <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"val"</span><span class="p">,</span> <span class="n">F</span><span class="p">.</span><span class="n">element_at</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"data"</span><span class="p">),</span> <span class="mi">2</span><span class="p">).</span><span class="n">cast</span><span class="p">(</span><span class="s">"int"</span><span class="p">))</span> \
  <span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"data"</span><span class="p">)</span>

<span class="n">result_df</span> <span class="o">=</span> <span class="n">event_df</span><span class="p">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s">"event_timestamp"</span><span class="p">,</span> <span class="s">"10 minutes"</span><span class="p">)</span> \
                    <span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">window</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="s">"event_timestamp"</span><span class="p">),</span> <span class="s">"5 minutes"</span><span class="p">))</span> \
                    <span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="s">"val"</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">"sum"</span><span class="p">))</span>

<span class="n">result_df</span><span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"console"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="s">"complete"</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s">"truncate"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> \
        <span class="p">.</span><span class="n">start</span><span class="p">().</span><span class="n">awaitTermination</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="ì°¸ê³ ">ì°¸ê³ </h1>

<ul>
  <li><a href="https://medium.com/expedia-group-tech/apache-spark-structured-streaming-operations-5-of-6-40d907866fa7" target="_blank">Neeraj Bhadani, Apache Spark Structured Streaming â Operations (5 of 6)</a></li>
  <li><a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html" target="_blank">Spark ê³µìë¬¸ì, Pyspark Structured Streaming Guide</a></li>
</ul>
:ET