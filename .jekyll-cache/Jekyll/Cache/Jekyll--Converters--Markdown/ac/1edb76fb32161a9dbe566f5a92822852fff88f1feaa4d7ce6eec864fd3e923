I"­<p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#kafka-listeners" id="markdown-toc-kafka-listeners">Kafka Listeners</a></li>
  <li><a href="#why-can-i-connect-to-the-broker-but-the-client-still-fails" id="markdown-toc-why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</a></li>
</ul>

<hr />

<p><a href="https://www.confluent.io/blog/kafka-listeners-explained/">ì›ë¬¸: Confluentë¸”ë¡œê·¸</a></p>

<h1 id="kafka-listeners">Kafka Listeners</h1>

<p>ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ê°€ ì¹´í”„ì¹´ì— ì—°ê²°ë˜ê¸° ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">advertised.listeners</code>(ë˜ëŠ” ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•  ê²½ìš° <code class="language-plaintext highlighter-rouge">KAFKA_ADVERTISED_LISTENERS</code>)ë¥¼ <strong>external IP ì£¼ì†Œ</strong>ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<p><img src="/images/kafka_36.png" alt="" /></p>

<p>ì•„íŒŒì¹˜ ì¹´í”„ì¹´ëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¦¬ë” íŒŒí‹°ì…˜ìœ¼ë¡œë¶€í„° ì“°ê³  ì½ì–´ì§€ë©° ë¦¬ë” íŒŒí‹°ì…˜ì€ ì–´ë–¤ ë¸Œë¡œì»¤ì—ë„ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¹´í”„ì¹´ì— ì—°ê²°ë˜ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ê³  ìˆëŠ” ë¸Œë¡œì»¤ê°€ ëˆ„êµ¬ì¸ì§€ì— ëŒ€í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤. ì´ ë©”íƒ€ë°ì´í„°ì—ëŠ” ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ëŠ” ë¸Œë¡œì»¤ì˜ ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë©° í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ì •ë³´ë¥¼ ì´ìš©í•´ ì¹´í”„ì¹´ì™€ ì—°ê²°ë  ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë§Œì•½ ì¹´í”„ì¹´ê°€ ë„ì»¤ì™€ ê°™ì€ ê°€ìƒë¨¸ì‹ ì´ ì•„ë‹Œ bare metal ìœ„ì—ì„œ ë™ì‘í•œë‹¤ë©´ ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ê·¸ì € <code class="language-plaintext highlighter-rouge">hostname</code>ì´ë‚˜ <code class="language-plaintext highlighter-rouge">localhost</code> ì •ë„ê°€ ë  ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¡°ê¸ˆ ë” ë³µì¡í•œ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ë˜ëŠ” ë©€í‹° ë…¸ë“œ í™˜ê²½ìœ¼ë¡œ ì˜¤ê²Œ ë˜ë©´ ì¡°ê¸ˆ ë” ì£¼ì˜ê°€ í•„ìš”í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>Letâ€™s assume you have more than one network. This could be things like:</p>

<p>Docker internal network(s) plus host machine
Brokers in the cloud (e.g., AWS EC2) and on-premises machines locally (or even in another cloud)
You need to tell Kafka how the brokers can reach each other but also make sure that external clients (producers/consumers) can reach the broker they need to reach.</p>

<p>ì´ˆê¸°ì— ë¸Œë¡œì»¤ê°€ ì—°ê²°ë˜ë©´ ì‹¤ì œë¡œ ë¦¬ë” íŒŒí‹°ì…˜ì„ ê°€ì§€ëŠ” ë¸Œë¡œì»¤ì˜ hostì™€ IPì˜ ì •ë³´ë¥¼ ëŒë ¤ì¤ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³¼ì •ì€ ë‹¨ì¼ ë…¸ë“œ í™˜ê²½ì—ì„œë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KAFKA_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_ADVERTISED_LISTENERS: LISTENER_BOB://kafka0:29092,LISTENER_FRED://localhost:9092
KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: LISTENER_BOB:PLAINTEXT,LISTENER_FRED:PLAINTEXT
KAFKA_INTER_BROKER_LISTENER_NAME: LISTENER_BOB
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">server.properties</code></p>

<ul>
  <li><strong>KAFKA_LISTENERS</strong>: ì¹´í”„ì¹´ê°€ ë¦¬ìŠ¤ë‹í•˜ê¸° ìœ„í•´ ë…¸ì¶œí•˜ëŠ” host/IPì™€ port</li>
  <li><strong>KAFKA_ADVERTISED_LISTENERS</strong>: í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë ¤ì£¼ëŠ” ë¦¬ìŠ¤ë„ˆì˜ host/IPì™€ port ë¦¬ìŠ¤íŠ¸</li>
  <li><strong>KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</strong>: ê° ë¦¬ìŠ¤ë„ˆë“¤ì´ ì‚¬ìš©í•˜ëŠ” security protocol</li>
  <li><strong>KAFKA_INTER_BROKER_LISTENER_NAME</strong>: ë¸Œë¡œì»¤ë“¤ ê°„ì˜ í†µì‹ ì„ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ</li>
</ul>

<p>ë¸Œë¡œì»¤ì— ì—°ê²°ë˜ë©´ ì—°ê²°ëœ ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜ë©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">kafkacat</code>ì€ ì´ëŸ¬í•œ ì •ë³´ë¥¼ ì•Œì•„ë³´ëŠ” ìœ ìš©í•œ íˆ´ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">-L</code>ì„ ì´ìš©í•˜ë©´ ì—°ê²°ëœ ë¦¬ìŠ¤ë„ˆì— ê´€í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 9092í¬íŠ¸ë¡œ ì—°ê²°ì‹œ, localhost:9092 ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜</span>
<span class="nv">$ </span>kafkacat <span class="nt">-b</span> kafka0:9092 <span class="se">\</span>
           <span class="nt">-L</span>
Metadata <span class="k">for </span>all topics <span class="o">(</span>from broker <span class="nt">-1</span>: kafka0:9092/bootstrap<span class="o">)</span>:
1 brokers:
  broker 0 at localhost:9092
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 29092í¬íŠ¸ë¡œ ì—°ê²°ì‹œ, kafka0:29092 ë¦¬ìŠ¤ë„ˆê°€ ë°˜í™˜</span>
<span class="nv">$ </span>kafkacat <span class="nt">-b</span> kafka0:29092 <span class="se">\</span>
           <span class="nt">-L</span>
Metadata <span class="k">for </span>all topics <span class="o">(</span>from broker 0: kafka0:29092/0<span class="o">)</span>:
1 brokers:
  broker 0 at kafka0:29092
</code></pre></div></div>

<h1 id="why-can-i-connect-to-the-broker-but-the-client-still-fails">Why can I connect to the broker, but the client still fails?</h1>

<p>ì´ˆê¸° ë¸Œë¡œì»¤ ì—°ê²°ì— ì„±ê³µí–ˆë‹¤ê³  í•˜ë”ë¼ë„, ë¸Œë¡œì»¤ê°€ ë°˜í™˜í•˜ëŠ” ë©”íƒ€ë°ì´í„° ì•ˆì— ìˆëŠ” ì£¼ì†Œë¡œ ì—¬ì „íˆ í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ê·¼í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì— ë¸Œë¡œì»¤ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¡œì»¬ ë¨¸ì‹ ì¸ ë…¸íŠ¸ë¶ì—ì„œ EC2ì— ìˆëŠ” ë¸Œë¡œì»¤ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. external hostnameì€ <code class="language-plaintext highlighter-rouge">ec2-54-191-84-122.us-west-2.compute.amazonaws.com</code>ì…ë‹ˆë‹¤. ë¡œì»¬ ë¨¸ì‹ ê³¼ EC2ê°€ í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìš°ë¦¬ì˜ ë¡œì»¬ ë¨¸ì‹ ì€ ec2-54-191-84-122.us-west-2.compute.amazonaws.comì„ 54.191.84.122ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ë¦¬ì¡¸ë¸Œ(resolve) í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>The broker receives the inbound connection on port 9092. It returns the metadata to the client, with the hostname ip-172-31-18-160.us-west-2.compute.internal, because this is the host name of the broker and the default value for listeners.</p>
  </li>
  <li>
    <p>The client then tries to send data to the broker using the metadata it was given. Since ip-172-31-18-160.us-west-2.compute.internal is not resolvable from the internet, it fails.</p>
  </li>
  <li>
    <p>Puzzled, we try the same thing from the broker machine itself: It works fine! Thatâ€™s because we are connecting to port 9092, which is configured as the internal listener and thus reports back its hostname as ip-172-31-18-160.us-west-2.compute.internal, which is resolvable from the broker machine (since itâ€™s its own hostname!).</p>
  </li>
  <li>
    <p>We can make life even easier by using kafkacat. Using the -L flag, we can see the metadata returned by the broker: Clear as day, the internal hostname is returned. This also makes this seemingly confusing error make a lot more senseâ€”connecting to one hostname, getting a lookup error on another:</p>
  </li>
</ul>
:ET